define(["backbone","underscore","models/base_job","validations/base_job","parsers/iso8601","moment"],function(e,t,n,r,i,s){function a(e){if(!(this instanceof a))return new a(e);if(!e)return!1;this.text=e}var o,u;return t.extend(a.prototype,{parseAs:function(e){var t;e||(e="RepeatingInterval");try{t=i.parse(this.text,e)}catch(n){t=!1}return t},isValid:function(){if(!!this.parseAs())return!0},getErrors:function(){var e={},n=this.text.split("/");if(this.isValid())return{};(!n[1]||!this.parseAs.call({text:n[1]},"DateTime"))&&t.extend(e,{startDate:!0,startTime:!0});if(!n[2]||!this.parseAs.call({text:n[2]},"Duration"))e.duration=!0;return t.isEmpty(e)&&(e.repeats=!0),e}}),o=n.extend({constructor:function(e,t){n.prototype.constructor.call(this,e,t)},url:function(e){return n.prototype.url.call(this,e)||"/scheduler/iso8601"},parse:function(e,n){var r;if(!e&&!t.isEmpty(this.attributes))return e;if(!e||!e.schedule)throw new Error("Scheduled jobs must have schedules");return r=e.schedule,t.merge({},e,o.scheduleToParts(r))},hasSchedule:function(){return!0},getWhitelist:function(){return["schedule","epsilon"].concat(n.getWhitelist())},parseSchedule:function(){var e=this.get("schedule"),t=o.scheduleToParts(e);this.set(t,{silent:!0})},validate:t.extend({},r,{schedule:{custom:"validateSchedule"},epsilon:{custom:"validateEpsilon"}}),validateSchedule:function(e,t){var n=new a(t);if(!n.isValid())return n.getErrors()},validateEpsilon:function(e,t){var n;try{n=i.parse(t,"Duration")}catch(r){n=null}if(!n)return'Epsilon is invalid. It should follow the same format as "Duration".'}},{scheduleToParts:function(e){var t;return e?(t=e.split("/"),{repeats:o.parseRepeats(t[0]),startDate:o.parseStartDate(t[1]),startTime:o.parseStartTime(t[1]),duration:o.parseDuration(t[2])}):{}},parseRepeats:function(e){var t=e.split("R").join("");return t||""},parseStartDate:function(e){var t=new Date(e);return t=="Invalid Date"&&(t="-"),s(t).format("YYYY-MM-DD")},parseStartTime:function(e){return e==undefined?"undefined":e.split("T")[1].split("Z")[0]},parseDuration:function(e){return e?e.slice(1):"-"}}),o});