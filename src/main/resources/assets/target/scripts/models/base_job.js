define(["backbone","underscore","moment","validations/base_job"],function(e,t,n,r){var i,s;return i=["name","command","owner","async","epsilon","executor"],s=e.Model.extend({defaults:function(){var e=new Date;return{name:"-",owner:"ateam@airbnb.com",startTime:n(e).format("HH:mm:ss"),startDate:n(e).format("YYYY-MM-DD"),repeats:"",duration:"T24H",epsilon:"PT15M",command:"-",schedule:"-",parents:[],retries:2,lastSuccess:"-",lastError:"-",successCount:0,errorCount:0,persisted:!1,async:!0}},idAttribute:"name",url:function(e){if(e==="put")return"/scheduler/job/"+encodeURIComponent(this.get("name"))},initialize:function(){return this.bindings(),this.trigger("add"),this},bindings:function(){this.listenTo(this,{setSchedule:this.updateSchedule,add:this.parseDisplayName,"before:validate":this.parseSchedule,"change:name":this.parseDisplayName,"change:repeats":this.updateSchedule,"change:startTime":this.updateSchedule,"change:startDate":this.updateSchedule,"change:duration":this.updateSchedule,"change:lastRunStatus":this.updateLastRunInfo})},hasSchedule:function(){return!0},updateSchedule:function(){var e=this.get("repeats"),t=this.get("startDate"),n=this.get("startTime"),r=this.get("duration"),i,s;s=["R"+e,t+"T"+n+"Z","P"+r],i=s.join("/"),console.log("schedule",i),this.set({schedule:i},{silent:!0})},validate:function(e,t){return"cannot validate base jobs"},run:function(e){return this.sync("run",this,e)},sync:function(n,r,i){var s,o,u=n;n==="run"&&(u="update");switch(n){case"delete":case"run":o=this.url("put"),i.data=null;break;default:o=this.url()}return e.sync.apply(this,[u,r,t.extend({},i,{url:o})]).done(t.bind(function(){this.set("persisted",!0)},this))},isNew:function(){return!this.get("persisted")},clone:function(){var e=new s(t.extend({},this.attributes,{persisted:!1}));return e.id=null,e},toJSON:function(){var e;return this.get("schedule")==="-"&&this.trigger("setSchedule"),e=this.toData(),t.pick.apply(null,[e].concat(this.getWhitelist()))},toData:function(){var n=e.Model.prototype.toJSON.call(this);return t.extend({},n,{parentsList:this.get("parents").join(", "),isNew:this.isNew(),hasSchedule:this.hasSchedule(),lastError:n.lastError||"none",lastSuccess:n.lastSuccess||"none"})},updateLastRunInfo:function(e,t,n){var r=t==="failure",i=t==="fresh",s=t==="success";e.set({lastRunSuccess:!!s,lastRunError:!!r,lastRunFresh:!!i,lastRunTime:e.get(r?"lastError":"lastSuccess")})},updateLeaf:function(){return!0},getWhitelist:function(){return[]},nextDate:function(){var e=this.get("duration"),t=this.get("currentDate"),n=xsdurationjs.add(e,t);return this.set("currentDate",n),n},parentsList:function(e){return this.get("parents").join(", ")},parseDisplayName:function(){var e=this.get("name");this.set("displayName",e?e.split("_").join(" "):"")},getInvocationCount:function(){return this.get("successCount")+this.get("errorCount")},validate:t.extend({},r),parseSchedule:function(){return this}},{getWhitelist:function(){return i.slice()}}),s});