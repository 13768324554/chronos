define(["underscore","components/run_counter"],function(e,t){function o(t,n){return e.map(t,function(e){return{word:e,matches:n}})}var n=Array.prototype.slice,r=Array.prototype.concat,i=e.bind,s;return s=function(){this.initialize.apply(this,n.call(arguments))},e.extend(s.prototype,{initialize:function(e){this.children={},this.value=(e||"").toLocaleLowerCase(),this.words={}},addWord:function(e){return!e||this._addWord(e,e),this},_addWord:function(t,r){var i,o,u,a;i=e.first(n.call(t,0,1)),u=n.call(t,1),a=u.join("");if(!i){if(arguments.length==2){var f=r.toLocaleLowerCase();this.words[f]=r}return}i=i.toLocaleLowerCase(),e.has(this.children,i)?o=this.getChild(i):o=this.children[i]=new s(i),o._addWord(a,r)},addWords:function(t){e.each(t,function(e){this.addWord(e)},this)},removeWord:function(e){return!e||this._removeWord(e,e),this},_removeWord:function(t,r){var i,s,o,u,a;i=e.first(n.call(t,0,1)),s=n.call(t,1),u=e.has(this.children,i);if(!i){var f,l;return f=r.toLocaleLowerCase(),l=e.has(this.words,f),delete this.words[f],l}return u?(o=this.getChild(i),a=o._removeWord,a&&o.getOwnWordsCount()<=0&&(o.markedForRemoval=!0),a):!1},getChild:function(e){var t=e||"";return this.children[t.toLocaleLowerCase()]},getChildCount:function(){return e.size(this.children)},getCasedWords:function(){return e.keys(this.words)},getWords:function(){return e.values(this.words)},getAllWordsMap:function(){var t=e.map(this.children,function(e,t){return e.getAllWordsMap()});return e.extend.apply(null,[{},this.words].concat(t))},getAllWords:function(){return e.values(this.getAllWordsMap())},getOwnWordsCount:function(){return e.size(this.words)},getAllWordsCount:function(){return e.size(this.getAllWordsMap())},getValue:function(){return this.value},getSimilar:function(n,r){r||(r=0);var i=this.getSimilarWithin(n,n,r,0,[],new t),s=e.chain(i).groupBy(function(e){return e.word}).map(function(t,n){return e.max(t,function(t){return t.matches?(t.matchScore=e.reduce(t.matches,function(e,t){return e+(t.end-t.start)},0),t.matchScore):-Infinity})}).value();return s},containsWord:function(e){return!!this.words[e.toLocaleLowerCase()]},containsWithin:function(e,t){function n(e,t){}},getSimilarInChildren:function(e,t,n){},getSimilarWithin:function(t,n,r,i,s,u){if(this.containsWord(n))return s.concat([{word:n,matches:u.getRuns()}]).concat(o(this.getAllWords(),u.getRuns()));if(i>r)return e.clone(s);var a=e.first(t),f=e.rest(t),l=f.join(""),c=!0,h=n.length-t.length,p=a&&this.getValue()===a.toLocaleLowerCase(),d=this.getChildCount()===0&&i<r,v=d;if(!a||v){var m=c?this.getAllWords():this.getWords();return p&&u.run(),o(m,u.getRuns()).concat(s)}p?u.run():this.getValue()&&this.getValue().length>0&&u.skip();var g=e.reduce(this.children,function(o){return function(u,a){var f=[],c,h,p;return h=[t,n,r,i,e.clone(s),o.clone()],o.lastWas("skip")?(e.extend(h,{3:i+1}),p=e.extend([],h,{0:l,5:o.clone()})):o.lastWas("run")?h[0]=l:o.lastWas(null),c=a.getSimilarWithin.apply(a,h),!p||(f=a.getSimilarWithin.apply(a,p)),u.concat(c,f)}}(u.clone()),[]);return g.concat(s)}}),s});