define(["underscore","components/prefix_trie"],function(e,t){var n=Array.prototype.slice,r=Array.prototype.concat,i=e.bind,s,o;return o=function(){this.initialize.apply(this,n.call(arguments))},e.extend(o.prototype,{initialize:function(t){var n=e.defaults(t,{wordAttribute:"name"});e.extend(this,{collection:n.collection,wordAttribute:n.wordAttribute}),this.buildTrie(),this.observeCollection()},buildTrie:function(){this.rootNode=new t,this.collection.each(this.updateAddNode,this)},getChangeEvent:function(){return["change",this.wordAttribute].join(":")},observeCollection:function(){var e=this.getChangeEvent();this.collection.on("reset",this.buildTrie,this).on("add",this.updateAddNode,this).on("remove",this.updateRemoveNode,this).on(e,this.updateTrie,this)},updateTrie:function(e){var t,n;t=e.previous(this.wordAttribute),n=e.get(this.wordAttribute),this.rootNode.addWord(n).removeWord(t)},updateAddNode:function(e){var t=e.get(this.wordAttribute);this.rootNode.addWord(t)},updateRemoveNode:function(e){var t=e.get(this.wordAttribute);this.rootNode.removeWord(t)},off:function(){return this.unobserveCollection()},unobserveCollection:function(){var e=this.getChangeEvent();this.collection.off("reset",this.buildTrie,this).off("add",this.updateAddNode,this).off("remove",this.updateRemoveNode,this).off(e,this.updateTrie,this)},getMatches:function(e,t){var n=t||1;return this.rootNode.getSimilar(e,n)},getMatcher:function(e){var t=this;return function(n){return t.getMatches(n,e)}}}),methods={FuzzyMatcher:o,create:function(e){s||(s=new o({collection:e}))},getMatcher:function(e){return s.getMatcher(e)},getFormattedMatcher:function(t,n){var r;return n?r=n.getMatcher(t):r=methods.getMatcher(t),function(t){var n=r(t);return e.chain(n).map(function(t){return{text:t.word,id:t.word,matches:e.map(t.matches,function(e){return[e.start,e.end]}),matchScore:-1*t.matchScore}}).sortBy("matchScore").value()}},longestCommonSubranges:function(e,t,r){var i=e.toLocaleLowerCase(),s=t.toLocaleLowerCase(),o=n.call(s),u=i.indexOf(s),a=[];r||(r=0);while(u<0&&!!o.length)a.unshift(o.pop()),u=i.indexOf(o.join(""));if(u>=0&&o.length>0){var f=u+o.length,l=[[u+r,f+r]];if(a.length>0){var c=methods.longestCommonSubranges(e.slice(f),a.join(""),f);return l.concat(c)}return l}return[]}},methods});