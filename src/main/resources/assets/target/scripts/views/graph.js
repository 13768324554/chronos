define(["jquery","d3","moment"],function(e,t,n){function d(e){return e*(180/Math.PI)}function v(n,r){return e(".graph-wrapper svg").length<1?m():t.selectAll("#graph-area svg g").remove(),g(n,r)}function m(){var n=e(".graph-wrapper"),d=e("#graph-area").width(),v=n.height(),m,g;return r=t.select("#graph-area").append("svg:svg").attr("width",d).attr("height",v),m=r.append("svg:defs"),g=function(n,r,i,s,o){return function(e){_.each(e,function(e){_.each(e,function(e){t.select(e).attr("viewBox",function(){return _.map([n,r,i,s],String).join(" ")}).attr("refX",i+n+o/2).attr("refY",s/2+r).attr("markerWidth",i).attr("markerHeight",s).attr("orient","auto").append("svg:path").attr("d",function(){return["M",n,",",r," ","L",n,",",s+r," ","L",i+n,",",s/2+r," ","L",n,",",r," ","Z"].join("")})})})}},m.selectAll("marker").data(["arrowhead","arrowhead-hover"]).enter().append("svg:marker").attr("id",String).call(g(f,l,u,a,o)),m.select("#arrowhead-hover").call(g(f,l,u,a,o*1.65)),i=t.layout.force().gravity(c).distance(h).charge(p).size([d,v]),s}function g(s,u){function w(n,r){var i=".target-"+n.id,s=".text-"+n.id;if(e(i).hasClass("hover"))return;t.select(this.parentNode).classed("hover",!0),console.log("added hover class to",this.parentNode,"this is",this),t.selectAll(i).classed("hover",!0).select(".link").transition().attr("marker-end","url(#arrowhead-hover)"),t.select(s).transition().attr("transform",function(e){return"translate("+o*1.65+", 0)"}),t.select(this).transition().attr("r",o*1.65),h[n.name].isMouseovered=!0}function E(e,n){var r=".target-"+e.id,i=".text-"+e.id;t.select(this.parentNode).classed("hover",!1),t.selectAll(r).classed("hover",!1).select(".link").transition().attr("marker-end","url(#arrowhead)"),t.select(i).transition().attr("transform","translate(0,0)"),t.select(this).transition().attr("r",o),h[e.name].isMouseovered=!1}function S(e){app.lightbox.close(),app.router.navigate("jobs/"+e.name,{trigger:!0})}function x(e,n){return _(["stopImmediatePropagation","preventDefault"]).each(function(e){t.event&&_.isFunction(t.event[e])&&t.event[e]()}),!1}var a={},f=[],l=[],c,h,p,d,v,m,g;d=u.getPlainNodes({scope:s}),h=_.reduce(d,function(e,t){return e[t.name]=t,e},{}),v=_.chain(u.getPlainPaths({scope:s})).map(function(e){return _.extend(e,{source:h[e.sourceName],target:h[e.targetName]})}).filter(function(e){return!!e.source&&!!e.target}).value(),i.nodes(d).charge(function(e,t){var n=e.name;return h[n]?-1e3:-100}).links(v).start(),c=r.selectAll(".link").data(i.links()).enter().append("svg:g").attr("class",function(e){var t=e.fake?["fake-link"]:[];return t.concat(["link","source-"+e.source.id,"target-"+e.target.id]).join(" ")}),m=c.append("svg:line").attr("class","link").attr("marker-end","url(#arrowhead)"),g=r.selectAll(".node").data(i.nodes()).enter().append("svg:g").attr({"class":"node","data-job-id":function(e){return e.name}}).call(i.drag),g.append("svg:circle").attr({"class":function(e){if(e.fail)return"fail"},cx:function(e){return 0},cy:function(e){return 0},r:function(e){return o}}).on("click",S).on("contextmenu",x).on("mouseover",w).on("mouseout",E);var b=g.append("svg:g").attr("class",function(e){return["text ","text-",e.id].join("")});y(b,{attributes:{dx:o,dy:"0.35em"},text:function(e){return e.name}}),y(b,{attributes:{dx:o,dy:"1.45em","class":"subtitle inv-subtitle"},text:function(e){if(!e.date)return"Has never ran";var t=e.fail?"error":"success";return["Last",t+":",n(e.date).fromNow()].join(" ")}}),y(b,{attributes:{dx:o,dy:"1.45em","class":"subtitle"},text:function(e){if(!e.date)return"Has never ran";var t=e.fail?"error":"success";return["Last",t+":",e.date].join(" ")}}),i.on("tick",function(){m.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),g.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})})}function y(e,n){var r,i,s;r=_.merge({attributes:{}},n||{}),s=r.attributes.class||"",r.attributes=_.omit(r.attributes,"class"),_.each(["shadow",""],function(n){e.append("svg:text").text(r.text||_.identity).attr("class",[s,n].join(" ")).each(function(e,n){i=t.select(this),_.each(r.attributes,function(e,t){i.attr(t,e)})})})}function b(){i&&i.stop()}function w(){i&&i.start()}var r,i,s,o,u,a,f,l,c,h,p;return c=.1,h=200,p=-1e3,u=10,a=10,l=-5,f=0,o=20,s={showScoped:v,start:w,stop:b}});