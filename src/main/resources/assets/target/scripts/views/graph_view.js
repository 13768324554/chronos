define(["backbone","underscore","collections/selections","views/graph","hbs!templates/graph_view","hbs!templates/select2_child","components/fuzzy_select2","bootstrap/tooltip"],function(e,t,n,r,i,s,o){function a(e,n){if(!e||!n)return;return t.reduce(e,function(e,t){return e[t[n]]=t,e},{})}function f(e,n){return t.map(n,function(t,n){return{id:n,text:n,locked:n!==e,lockedFor:e}})}function l(e,n){var r=['[data-select2-id="',e,'"]'].join(""),i=t.chain(n).keys().without(e).value();return this.$(r).find("ul.children").html(s({children:i})),this}var u;return u=e.View.extend({className:"graph-area",template:i,events:{'click [data-lightbox-close="true"]':"closed","click .icon-play":"resumed","click .icon-pause":"paused"},initialize:function(){t.bindAll(this,"filter"),this.collection=new n,this.listenTo(this.collection,{add:this.filterSelectionsAdd,remove:this.filterSelectionsRemove,reset:this.filterSelectionsReset}),this.collection.on("all",function(){var e=Array.prototype.slice.call(arguments,0,1),t=Array.prototype.slice.call(arguments,1);console.log("GraphView collection event","\n","event name:",e,"\n","event args:",t,"\n","collection",this.collection,"\n","this",this)},this)},render:function(){var e=this.template();return this.$el.html(e),o.attach(this.$filterField(),{width:"90%",multiple:!0,collection:app.jobsCollection}).on("change",this.filter),this},postModifyRelatedTo:function(){this.$('[data-toggle="tooltip"]').tooltip()},removeRelatedTo:function(e){var n,r,i,s,o,u;if(!e)return;i=this.$filterField(),n=i.select2("data"),r=t.reduce(n,function(t,n){return o=n.locked&&n.lockedFor&&n.lockedFor===e,u=n.id===e,!o&&!u&&(t[n.id]=n),t},{}),i.select2("data",t.values(r)),s=this.collection.filter(function(e){return!r[e.id]}),this.collection.length-s.length<1?this.collection.reset():this.collection.remove(s,{silent:!0}),this.showGraph()},setRelatedTo:function(e,t){if(!t)return;var n=f(e,t);this.collection.reset(n)},setTarget:function(e){var t;return t=app.jobsGraphCollection.getWithRelatedNodes(e),this.setRelatedTo(e,t)},addTarget:function(e){},updateRelatedTo:function(e,n){var r,i,s,o;if(!n)return;r=this.$filterField(),i=a(r.select2("data"),"text"),s=a(f(e,n),"text"),o=t.chain(i).merge(s).values().value(),this.collection.reset(o)},filterSelectionsAdd:function(){var e=Array.prototype.slice.call(arguments);return this.filterSelections.apply(this,e)},filterSelectionsRemove:function(){var e=Array.prototype.slice.call(arguments);return this.filterSelections.apply(this,e)},filterSelectionsReset:function(e,t){var n=e.toJSON(),r=this.$filterField();r.select2("data",n),this.postModifyRelatedTo(n),this.collection.isEmpty()},showGraph:function(){var e=this.collection.toJSON();t.isEmpty(e)?e=null:e=t.reduce(e,function(e,t){return e[t.id]=t,e},{}),r.showScoped(e,app.jobsGraphCollection)},showTree:function(){var e=this.collection.toJSON(),n=app.jobsGraphCollection,r,i;t.isEmpty(e)?r=app.jobsGraphCollection.toJSON():r=t.filter(e,function(e){return!e.locked}),i=t.merge.apply(null,t.map(r,function(e){return n.get(e.id).getRelatedAsTree()}))},filterSelections:function(e){var t,n=this,r=Array.prototype.slice.call(arguments);!this.collection||(t=app.jobsCollection.getRelatedTo(e.id),this.updateRelatedTo(e.get("text"),t)),this.showGraph()},filter:function(e){var t=e.added,n=e.removed,r;!t||this.collection.add(t),!n||this.removeRelatedTo(n.id)},$filterField:function(){return this.$("#graph-filter")},closed:function(e){o.unattach(this.$filterField())},resumed:function(e){e&&e.preventDefault(),r.start()},paused:function(e){e&&e.preventDefault(),r.stop()}}),u});