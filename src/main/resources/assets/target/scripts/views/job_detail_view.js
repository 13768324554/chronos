define(["jquery","backbone","underscore","views/job_detail_header_view","views/bound_view","components/tooltip_view","components/fuzzy_select2","hbs!templates/job_detail_view","hbs!templates/job_persistence_error","hbs!templates/job_persistence_success","templates/helpers/join_with","bootstrap/tooltip","bootstrap/button","bootstrap/alert","jquery/pickadate","bootstrap/timepicker"],function(e,t,n,r,i,s,o,u,a,f){function d(e){return n.isNumber(e)?e>=400&&e<=599:e&&e.status?d(e.status):!1}function v(e,t){return n.isArray(e)&&n.chain(e).first().isObject().value()?n.chain(e).map(function(e){return n.keys(e)}).flatten().uniq().map(function(e){return{name:[t,e].join(" "),value:e,field:e}}).value():{name:t,value:e,field:t}}var l,c,h,p;return l=", ",h="/srv/mesos/utils/async-executor.arx",p=i.prototype.remove,c=i.extend({mixins:{tooltips:s.InstanceMethods},className:function(){var e=["job-details-wrapper"];return this.model&&this.model.cid&&e.push("job-"+this.model.cid),e.join(" ")},template:u,events:{"click .invalid-field":"highlightInvalidField"},initialize:function(){this._childViews={},n.bindAll(this,"updateParents","saveError","createError","saveSuccess","createSuccess"),this.listenTo(this.model,{invalid:this.renderInvalid,save:this.save}),this.addRivets(),this.addTooltips()},remove:function(){return this.disableEdit(),this.undelegateEvents(),p.call(this)},getBindModels:function(){return{job:this.model}},render:function(){var e=this.template(this.model.toData());return this.$el.html(e),this.addRivets(),this.renderParents(),this.renderHeader(),this.trigger("render"),this.$el.hasClass("edit-job")&&this.enableEdit(),this},renderInvalid:function(e,t){console.log("render invalid","\n","model",e,"\n","errors",t);var r={save:!0};return this.enableEdit(),r.validationErrors=n.map(t,function(e,t){return this.highlightValidationError(e,t),v(e,t)},this),this.renderMessage("error",a,r),this},renderHeader:function(){var e=this._childViews.header;return e||(e=new r({model:this.model}),this.listenTo(e,{edit:this.edit,cancel:this.cancel,close:this.close,save:this.save,create:this.create,toggle:this.toggle})),e.setElement(this.$(".job-detail-nav-view")).render()},renderParents:function(){if(this.model.get("parents").length){var e=this.$el.find(".parents-wrapper"),t=this.model.get("parents").join(l);this.model.set("parentsList",t),e.find(".parents").html(t),e.find("input").val(t),e.show()}},renderDisplayName:function(){console.log("renderDisplayName"),this.$el.find(".toggleName").html(this.model.get("name"))},serialize:function(){return e("#job-form").serialize()},click:function(){this.blurAll()},setNew:function(){var e=this.$("form");e.hasClass("create-job")||(this.$("form").addClass("edit-job create-job"),this.enableEdit())},save:function(){this.serializeInputs(),this.model.save(null,{success:this.saveSuccess,error:this.saveError}),this.disableEdit()},persistenceError:function(e,t,r){var i=e&&e.validationError,s={create:t==="create",save:t==="save"},o;if(d(r))s.serverError={text:r.responseText,status:r.status};else if(!i){o=e.id,e.id+=Math.random(),e.validationError=e.validate(e.attributes),e.id=o;if(!e.validationError)return;return this.persistenceError(e,t)}!i||(s.validationErrors=n.reduce(i,function(e,t,n){this.highlightValidationError(t,n);var r=v(t,n);return e.concat(r)},[],this)),this.renderMessage("error",a,s)},highlightValidationError:function(e,t){console.log("highlightValidationError",e,t);var r=this.$("form"),i;n.isArray(e)&&e.length===1&&(e=e[0]),n.isObject(e)?n.each(e,this.highlightValidationError,this):(i=r.find('[name="'+t+'"]'),$parent=i.parents(".control-group").first().addClass("error"),e!==!0&&$parent.find(".help-inline").text(e))},createError:function(e,t,n){this.setNew(),this.persistenceError(e,"create",t),console.log("create error","args",arguments,"this",this)},saveError:function(e,t,n){this.enableEdit(),this.persistenceError(e,"save",t),console.log("save error","args",arguments,"this",this)},persistenceSuccess:function(e,t){var n={jobName:e.get("name"),create:t==="create",save:t==="save"};this.disableEdit(),this.render(),this.renderMessage("success",f,n)},createSuccess:function(e,t,n){this.persistenceSuccess(e,"create")},saveSuccess:function(e,t,n){this.persistenceSuccess(e,"save")},renderMessage:function(e,t,r){var i,s,o,u;r||(r={}),i=["alert",e].join("-"),s=this.$(".job-detail-message").show(),o=this.model.get("name"),s.find(".job-message").html(t(n.extend({},r,{jobName:o,alertClass:i}))).find(".alert").alert().on("closed",function(){s.hide(),s.parents("form").find(".control-group.error").removeClass("error")})},serializeInputs:function(){var t=this.$el.find(".job-input"),r=this.model;t.each(function(t,i){var s=e(i),o=s.attr("name"),u=s.val();console.log(o,u);if(o=="async"){if(!s.is(":checked"))return;u=parseInt(u,10)!==0}else o=="parents"&&(u=u.split(","),u=n.map(u,function(e){return e.trim()}),u[0]==""&&(u=[]));r.set(o,u)}),r.trigger("setSchedule")},dispose:function(){this.off(),e(".right-pane").html("")},$parents:function(){return this.$('input.job-input[name="parents"]')},disableEdit:function(){o.unattach(this.$parents()),this.$(".async .btn-group .btn").addClass("disabled"),this.$("form").removeClass("edit-job create-job"),this.$(".timepicker").timepicker("remove")},enableEdit:function(){var e=this.$el.find("form");e.addClass("edit-job"),this.$(".async .btn-group .btn").removeClass("disabled"),this.$(".datepicker").pickadate({format:"yyyy-mm-dd",formatSubmit:"yyyy-mm-dd",dateMin:!0}),this.$(".timepicker").timepicker({template:!1}),o.attach(this.$parents(),{collection:app.jobsCollection,width:"98%",multiple:!0,exclusions:this.model?[this.model.id]:[]}).on("change",this.updateParents)},updateParents:function(e){var t=e.added,r=e.removed,i=this.$(".job-detail.sched"),s=this.model.get("parents");t&&(s=s.concat(t.id)),r&&(s=n.without(s,r.id)),this.model.set({parents:s},{silent:!0}),n.isEmpty(s)?i.show():i.hide()},edit:function(e){var t=this.$("form");this.model.isNew()?this.setNew():(t.addClass("edit-job"),this.enableEdit()),t.find("input:enabled:visible").first().focus()},create:function(e){e&&e.preventDefault()&&e.stopPropagation();var t,n,r,i,s;this.disableEdit(),this.serializeInputs(),s=this,t=this.model,n=app.jobsCollection.create(t.toData(),{success:function(e,r,i){s.createSuccess(e,r,i),setTimeout(function(){n.set({persisted:!0},{silent:!0}),app.resultsCollection.add(n),app.detailsCollection.remove(t).add(n)},1e3)},error:function(e,t,n){!i||s.createError(e,t,n)}}),r=app.jobsCollection.get(n.cid),i=n.isValid()&&!!r,i||this.createError(n)},toggle:function(e){this.$el.hasClass("up")?(this.$el.removeClass("up"),this.enableEdit()):(this.disableEdit(),this.$el.addClass("up"))},cancel:function(e){var t=this.$el.hasClass("create-job");e&&e.preventDefault(),this.disableEdit(),this.model.isNew()&&this.close()},close:function(){var t=this.model.cid;console.log("Close",arguments,this,this.$el),this.model.isNew()?app.detailsCollection.remove(t,{create:!0}):app.detailsCollection.remove(t),e("."+t).removeClass("active"),this.remove()},blur:function(t){var n=e(t.target),r=e(t.currentTarget).val(),i=e(t.currentTarget).attr("name");this.$el.find("."+i).html(r),this.model.set(i,""+r)},setAsync:function(e){e&&e.preventDefault()},validate:function(t){t&&t.preventDefault();var n=this.model.isValid(),r=this.model.validate(this.model.attributes);e(t.target).css({"background-color":r?"red":"green"})},highlightInvalidField:function(t){var n=e(t.target),r=n.data("form-field");t&&t.preventDefault(),this.enableEdit(),this.$("form").find('input[name="'+r+'"]').focus()}}),c});