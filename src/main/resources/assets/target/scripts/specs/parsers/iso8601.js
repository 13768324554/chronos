define(["underscore","jquery","mocha","chai","parsers/iso8601","components/date_node","json!specs/test_data.json"],function(e,t,n,r,i,s,o){function h(){return l.call(arguments).join("")}function p(n,r){var i=t("#test-data"),s={};s[n]=r,i.val().length>0&&e.merge(s,JSON.parse(i.val())),i.val(JSON.stringify(s))}function d(t,n){return[t,"- testing",e.size(n),"objects"].join(" ")}function v(t,n,r,i){function o(t){var n,r;n=e.chain(s).filter(function(e){return e.i>t}).max(function(e){return e.i}).value(),n=Math.abs(n)===Infinity?null:n;if(!n)return[i,t].join("");var o=n.i.toString().length-t.toString().length;return[i,e.first(n.z,o).join(""),t].join("")}r||(r=(n+"").length),i||(i="");var s=e.chain(1).range(r).map(function(e){var t=(new Array(e+1)).join("0");return{i:parseInt(1+t,10),z:t}}).sortBy(function(e){return e.i}).value();return e.chain(t).range(n+1).map(function(e){return{str:o(e),"int":e}}).value()}function m(t,n){function r(t){if(t.length===1)return t[0];if(t.length>1){var i=r(t.slice(1));return i.reduce(function(r,i){return r.concat(e.first(t).map(function(e){return{str:[e.str,i.str].join(n)}}))},[])}}return n||(n=""),r(t)}var u=r.expect,a=r.Assertion,f=i.parse,l=Array.prototype.slice,c;r.use(function(t,n){function r(e){return e instanceof s.__super__.constructor}function i(t){return!!e.result(t,"original")&&!!e.result(t,"parsed")}a.addMethod("parseableAs",function(t){var n=this._obj,r,i;(new a(this._obj)).to.be.a("string");try{i=f(n,t)}catch(s){r=e.pick(s,"name","expected","found","message","offset","line","column")}return this.assert(!r,"expected #{this} to be parseable as #{exp} but got #{act}","expected #{this} to not be parseable, but got #{act}",t,r?JSON.stringify(r):i),this._obj={original:n,parsed:i},this}),a.overwriteMethod("respondTo",function(s){return function(o,u){var a=n.flag(this,"object");if(r(a)){var f=a[o],l,c;(new t.Assertion(f)).to.be.a("function"),e.isObject(u)&&e.has(u,"with")&&(new t.Assertion(f.call(a))).to.be.eql(u["with"])}else if(i(a)){var h=new t.Assertion(a.parsed);h.to.respondTo.apply(h,arguments)}else s.apply(this,arguments)}})}),c=function(){function n(e,t,n){return t||(t=[]),n||(n=e),{standard:e,extended:t,all:n}}var t={};return t.calendarYears=e.memoize(function(){var e={str:"1984","int":1984},t={str:"0010","int":10},n={str:"+00501","int":501},r={str:"-00501","int":-501},i={str:"-10000","int":-1e4};return{standard:[e,t],extended:[n,r,i],all:[e,t,n,r,i]}}),t.calendarMonths=e.memoize(function(){var e=v(1,12,2);return{standard:e,extended:[],all:e}}),t.calendarDaysOfMonth=e.memoize(function(){var e=v(1,31);return{standard:e,extended:[],all:e}}),t.calendarWeeks=e.memoize(function(){var e=v(1,53,2,"W");return{standard:e,extended:[],all:e}}),t.calendarDaysOfWeek=e.memoize(function(){var e=v(1,7);return n(e,[],e)}),t.calendarDaysOfYear=e.memoize(function(){var e=v(1,365,3);return n(e,[],e)}),t.time||(t.time={}),t.time.hours=e.memoize(function(){var e=v(0,24);return n(e,[],e)}),t.time.minutes=e.memoize(function(){var e=v(0,59);return n(e,[],e)}),t.time.seconds=e.memoize(function(){var e=v(0,60);return n(e,[],e)}),t.time.zones=e.memoize(function(){var t=["Z"];["+","-"].forEach(function(t){e.range(0,10).forEach(function(e){})})}),t}(),describe("ISO-8601 parts",function(){var t,n,r,i,s,a,f,l,p,v;return before(function(){t=o.dates.parts.years,n=o.dates.parts.months,r=o.dates.parts.daysOfMonth,s=o.dates.parts.weeks,a=o.dates.parts.daysOfYear}),describe("Dates",function(){describe("Years part",function(){it("should properly parse standard YYYY",function(){var e;t.standard.forEach(function(e,t){u(e.str).to.be.parseableAs("YYYY").and.to.respondTo("getValue",{"with":e.int})},this)}),it("should properly parse extended [+-]Y?YYYY",function(){var e;t.extended.forEach(function(e,t){u(e.str).to.be.parseableAs("YYYY").and.to.respondTo("getValue",{"with":e.int})},this)})}),describe("Month of year part",function(){it("should properly parse MM",function(){var e;n.all.forEach(function(e,t){var n=u(e.str).to.be.parseableAs("MM")})})}),describe("Day of month part",function(){it("should properly parse DD",function(){var e;r.all.forEach(function(e,t){var n=u(e.str).to.be.parseableAs("DD")})})}),describe("Calendar Dates",function(){var e,t,n,r;before(function(){e=o.dates.calendar.dateFullDash,t=o.dates.calendar.dateFull,n=o.dates.calendar.dateDash,r=o.dates.calendar.date}),describe("with dashes",function(){it("should parse full dates",function(){e.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)}),it("should parse dates without [DD]",function(){t.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)})}),describe("without dashes",function(){it("should parse full dates",function(){t.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)}),it("should NOT parse dates without [DD]",function(){r.forEach(function(e){u(e.str).not.to.be.parseableAs("Date")},this)})})}),describe("Week Dates",function(){var e,t,n,r;before(function(){e=o.dates.week.dateFullDash,t=o.dates.week.dateFull,n=o.dates.week.dateDash,r=o.dates.week.date}),describe("with dashes",function(){it("should parse full dates",function(){e.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)}),it("should parse dates without [D]",function(){t.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)})}),describe("without dashes",function(){it("should parse full dates",function(){t.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)}),it("should parse dates without [D]",function(){r.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)})})}),describe("Ordinal Dates",function(){var e,t;before(function(){e=o.dates.ordinal.dateDash,t=o.dates.ordinal.date}),describe("with dashes",function(){it("should parse full dates",function(){e.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)})}),describe("without dashes",function(){it("should parse full dates",function(){t.forEach(function(e){u(e.str).to.be.parseableAs("Date")},this)})})})}),before(function(){f=c.time.hours(),l=c.time.minutes(),p=c.time.seconds(),v=c.time.zones()}),describe("Times",function(){var e,t,n,r,i,s,a,f,l,c;before(function(){e=o.times.week.hh_mm_ss,t=o.times.week.hh_mm,n=o.times.week.hhmmss,r=o.times.week.hhmm,i=o.times.week.hh}),describe("without timezones",function(){describe("with colons",function(){it(d("should parse hh:mm:ss",e),function(){e.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)}),it(d("should parse hh:mm",t),function(){t.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)})}),describe("without colons",function(){it(d("should parse hhmmss",n),function(){n.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)}),it(d("should parse hhmm",r),function(){r.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)}),it(d("should parse hh",i),function(){i.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)})})});var p;before(function(){s=o.time_zones.week.hh_mm_ss_tz,a=o.time_zones.week.hh_mm_tz,f=o.time_zones.week.hhmmss_tz,l=o.time_zones.week.hhmm_tz,c=o.time_zones.week.hh_tz}),describe("with timezones",function(){describe("just timzones",function(){it("should parse Z",function(){u("Z").to.be.parseableAs("TimeZone")}),it(d("should parse +hh:mm",t),function(){t.forEach(function(e){u(h("+",e.str)).to.be.parseableAs("TimeZone")},this)}),it(d("should parse -hh:mm",t),function(){t.forEach(function(e){u(h("-",e.str)).to.be.parseableAs("TimeZone")},this)}),it(d("should parse +hhmm",t),function(){r.forEach(function(e){u(h("+",e.str)).to.be.parseableAs("TimeZone")},this)}),it(d("should parse -hhmm",t),function(){r.forEach(function(e){u(h("-",e.str)).to.be.parseableAs("TimeZone")},this)}),it(d("should parse +hh",i),function(){i.forEach(function(e){u(h("+",e.str)).to.be.parseableAs("TimeZone")})}),it(d("should parse -hh",i),function(){i.forEach(function(e){u(h("-",e.str)).to.be.parseableAs("TimeZone")})})}),describe("combined timezones and times",function(){describe("with colons",function(){it(d("should parse hh:mm:ss + tz",s),function(){s.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)}),it(d("should parse hh:mm + tz",a),function(){a.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)})}),describe("without colons",function(){it(d("should parse hhmmss + tz",f),function(){f.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)}),it(d("should parse hhmm + tz",l),function(){l.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)}),it(d("should parse hh + tz",c),function(){c.forEach(function(e){u(e.str).to.be.parseableAs("Time")},this)})})})})}),describe("Date Times",function(){var t,n,r,i,s;before(function(){t=o.dates.ordinal,n=o.dates.calendar,r=o.dates.week,i=o.times.week,s=o.time_zones.week}),describe("with ordinal dates",function(){var n=t;describe("with timezones",function(){it("should parse",function(){e.each(n,function(t,n){t.forEach(function(t){e.each(s,function(e,n){e.forEach(function(e){u(h(t,"T",e)).to.be.parseableAs("DateTime")},this)},this)},this)},this)})}),describe("without timezones",function(){it("should parse",function(){e.each(n,function(t,n){t.forEach(function(t){e.each(i,function(e,n){e.forEach(function(e){u(h(t,"T",e)).to.be.parseableAs("DateTime")},this)},this)},this)},this)})})}),describe("with calendar dates",function(){var t=n;describe("with timezones",function(){it("should parse",function(){e.each(t,function(t,n){t.forEach(function(t){e.each(s,function(e,n){e.forEach(function(e){u(h(t,"T",e)).to.be.parseableAs("DateTime")},this)},this)},this)},this)})}),describe("without timezones",function(){it("should parse",function(){e.each(t,function(t,n){t.forEach(function(t){e.each(i,function(e,n){e.forEach(function(e){u(h(t,"T",e)).to.be.parseableAs("DateTime")},this)},this)},this)},this)})})}),describe("with week dates",function(){var t=r;describe("with timezones",function(){it("should parse",function(){e.each(t,function(t,n){t.forEach(function(t){e.each(s,function(e,n){e.forEach(function(e){u(h(t,"T",e)).to.be.parseableAs("DateTime")},this)},this)},this)},this)})}),describe("without timezones",function(){it("should parse",function(){e.each(t,function(t,n){t.forEach(function(t){e.each(i,function(e,n){e.forEach(function(e){u(h(t,"T",e)).to.be.parseableAs("DateTime")},this)},this)},this)},this)})})})}),describe("Durations",function(){var t,n,r,i,s;before(function(){t=o.dates.ordinal,n=o.dates.calendar,r=o.dates.week,i=o.times.week,s=o.time_zones.week}),describe("as PnYnMnDTnHnMnS",function(){var t,n,r;before(function(){var i=10,s,o;s=e.chain(i).range().map(function(t){return["Y","M","D"].reduce(function(t,n){var r=e.random(0,i-1);return r>0&&t.push(h(r,n)),t},[])}),o=e.chain(i).range().map(function(t){return h.apply(null,["H","M","S"].reduce(function(n,r){var i=e.random(0,t);return i>0&&n.push(h(i,r)),n},[]))}),t=s.map(function(e){return h.apply(null,["P"].concat(e))}),n=o.map(function(e){return h.apply(null,["P","T"].concat(e))}),r=s.reduce(function(e,t){return o.forEach(function(n){e.push(h.apply(null,["P"].concat(t).concat("T",n)))}),e},[])}),describe("full specifier",function(){it("should parse",function(){r.forEach(function(e){u(e).to.be.parseableAs("Duration")})}),it("should parse just first half",function(){t.forEach(function(e){u(e).to.be.parseableAs("Duration")})}),it("should parse just second half",function(){n.forEach(function(e){u(e).to.be.parseableAs("Duration")})})})}),describe("as PnW",function(){e.range(1,53).forEach(function(e){u(h("P",e,"W")).to.be.parseableAs("Duration")},this)}),describe("as P<date>T<time>",function(){var i=20;describe("with week dates",function(){it("should parse",function(){e.chain(r).first(i).forEach(function(t){e.each(s,function(e,n){e.forEach(function(e){u(h("P",t.str,"T",e.str)).to.be.parseableAs("Duration")},this)},this)},this)})}),describe("with ordinal dates",function(){it("should parse",function(){e.chain(t).first(i).forEach(function(t){e.each(s,function(e,n){e.forEach(function(e){u(h("P",t.str,"T",e.str)).to.be.parseableAs("Duration")},this)},this)},this)})}),describe("with calendar dates",function(){it("should parse",function(){e.chain(n).first(i).forEach(function(t){e.each(s,function(e,n){e.forEach(function(e){u(h("P",t.str,"T",e.str)).to.be.parseableAs("Duration")},this)},this)},this)})})})}),describe("Time intervals",function(){var t={"<start>/<end>":"2007-03-01T13:00:00Z/2008-05-11T15:30:00Z","<start>/<duration>":"2007-03-01T13:00:00Z/P1Y2M10DT2H30M","<duration>/<end>":"P1Y2M10DT2H30M/2008-05-11T15:30:00Z"};e.each(t,function(e,t){it(h("should parse",t),function(){u(e).to.be.parseableAs("Interval")})},this)}),describe("Repeating intervals",function(){var t={"Rnn/<interval>":"R5/2008-03-01T13:00:00Z/P1Y2M10DT2H30M","R/<interval>":"R/P1Y2M10DT2H30M/2008-05-11T15:30:00Z"};e.each(t,function(e,t){it(h("should parse",t),function(){u(e).to.be.parseableAs("RepeatingInterval")})},this)}),!0})});