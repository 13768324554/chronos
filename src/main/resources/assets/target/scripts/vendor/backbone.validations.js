// Copyright (C) 2011 Neal Stewart
//
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
// of the Software, and to permit persons to whom the Software is furnished to do
// so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

define(["require","exports","module","underscore","backbone"],function(e,t,n){(function(t){function s(e){var t,n,r={};this&&this.trigger&&this.trigger("before:validate");for(var i in this._attributeValidators){try{var s=e[i]}catch(o){debugger}var u=this._attributeValidators[i];u&&(t=u(this,s)),t&&(n=!0,r[i]=t)}return n?r:!1}function o(e,t){return _.bind(n.min,null,t)}function u(e,t){return _.bind(n.max,null,t)}function a(e,t,r){var s,o,u;t==="type"&&(t=r),s=n[t],s||(s=i(t));if(!s)throw"Improper validation type '"+t+"'";return _.bind(s,null,r,e)}function f(e,t){var n=[],r,i;for(r in t)i=t[r],n.push(a(e,r,i));return function(e,t,r,i){var s,o,u=[];for(var a=0,f=n.length;a<f;a++)s=n[a],o=s(e,t),o&&(_.isArray(o)?u=u.concat(o):u.push(o));return u.length?u:!1}}function l(e){var t,n={};for(var r in e)t=e[r],n[r]=f(r,t);return n}function h(e,t){var n=c.apply(this,arguments);return n||_.each(this.validationError,function(e,n){this.trigger("invalid:"+n,this,this.validationError,t)},this),n}typeof e!="undefined"&&(_=e("underscore"),t=e("backbone")),t.Validations={};var n={custom:function(e,t,n,r){return n[e](t,r)},required:function(e,t,n,r){return e&&(_.isNull(r)||_.isUndefined(r)||r==="")?"required":!1},"in":function(e,t,n,r){return _.include(e,r)?undefined:"in"},email:function(e,t,n,r){var i=new RegExp("[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?","i");if(_.isString(r)&&!r.match(i))return"email"},url:function(e,t,n,r){var i=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;if(_.isString(r)&&!r.match(i))return"url"},number:function(e,t,n,r){return isNaN(r)?"number":undefined},Array:function(e,t,n,r){return _.isArray(r)?undefined:"Array"},Boolean:function(e,t,n,r){return _.isBoolean(r)?undefined:"Boolean"},String:function(e,t,n,r){return _.isString(r)?undefined:"String"},digits:function(e,t,n,r){var i=!_.isUndefined(r);return!/^\d+$/.test(r)&&i?"digits":undefined},pattern:function(e,t,n,r){if(_.isString(r))return e.test(r)?!1:"pattern"},min:function(e,t,n,r){if(r<e)return"min"},max:function(e,t,n,r){if(r>e)return"max"},minlength:function(e,t,n,r){if(_.isString(r)&&r.length<e)return"minlength"},maxlength:function(e,t,n,r){if(_.isString(r)&&r.length>e)return"maxlength"},arrayElem:function(e,t,n,r){return _.isArray(r)&&!_.all(r,e)?"validElem":!1}},r={},i=function(e){var t=r[e];if(!t)throw"custom validator '"+e+"' could not be found.";return t};t.Validations.addValidator=function(e,t){if(n.hasOwnProperty(e)||r.hasOwnProperty(e))throw"existing validator";r[e]=t};var c=t.Model.prototype._validate,p=t.Model,d=t.Model.prototype.constructor;t.Validations.Model=t.Model.extend({constructor:function(){typeof this.validate=="object"&&this.validate!==null&&(this.constructor.prototype._attributeValidators||(this.constructor.prototype._attributeValidators=l(this.validate),this.constructor.prototype.validate=s,this.constructor.prototype._validate=h),this.validate=_.bind(function(e){return s(e||this.attributes)},this),this._attributeValidators=this.constructor.prototype._attributeValidators),d.apply(this,arguments)}}),t.Model=t.Validations.Model,t.Validations.Model.noConflict=function(){t.Model=p}})(typeof Backbone=="undefined"?null:Backbone)});