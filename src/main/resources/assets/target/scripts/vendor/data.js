//     (c) 2012 Michael Aufreiter
//     Data.js is freely distributable under the MIT license.
//     Portions of Data.js are inspired or borrowed from Underscore.js,
//     Backbone.js and Google's Visualization API.
//     For all details and documentation:
//     http://substance.io/michael/data-js

/*!
  Math.uuid.js (v1.4)
  http://www.broofa.com
  mailto:robert@broofa.com

  Copyright (c) 2010 Robert Kieffer
  Dual licensed under the MIT and GPL licenses.
  */

define(["underscore"],function(e){var t={};t.VERSION="0.6.2",t.VALUE_TYPES=["string","object","number","boolean","date"],t.isValueType=function(n){return e.include(t.VALUE_TYPES,e.last(n))},t.uuid=function(e){var t="0123456789abcdefghijklmnopqrstuvwxyz".split(""),n=[],r=16,i=32;if(i)for(var s=0;s<i;s++)n[s]=t[0|Math.random()*r];else{var o;n[8]=n[13]=n[18]=n[23]="-",n[14]="4";for(var s=0;s<36;s++)n[s]||(o=0|Math.random()*16,n[s]=t[s==19?o&3|8:o])}return(e?e:"")+n.join("")};var n=/\s+/;return e.Events={on:function(e,t,r){var i,s,o,u,a;if(!t)return this;e=e.split(n),i=this._callbacks||(this._callbacks={});while(s=e.shift())a=i[s],o=a?a.tail:{},o.next=u={},o.context=r,o.callback=t,i[s]={tail:u,next:a?a.next:o};return this},off:function(t,r,i){var s,o,u,a,f,l;if(!(o=this._callbacks))return;if(!(t||r||i))return delete this._callbacks,this;t=t?t.split(n):e.keys(o);while(s=t.shift()){u=o[s],delete o[s];if(!u||!r&&!i)continue;a=u.tail;while((u=u.next)!==a)f=u.callback,l=u.context,(r&&f!==r||i&&l!==i)&&this.on(s,f,l)}return this},trigger:function(e){var t,r,i,s,o,u,a;if(!(i=this._callbacks))return this;u=i.all,e=e.split(n),a=Array.prototype.slice.call(arguments,1);while(t=e.shift()){if(r=i[t]){s=r.tail;while((r=r.next)!==s)r.callback.apply(r.context||this,a)}if(r=u){s=r.tail,o=[t].concat(a);while((r=r.next)!==s)r.callback.apply(r.context||this,o)}}return this}},e.Events.bind=e.Events.on,e.Events.unbind=e.Events.off,t.Query={query:function(n){function r(t){return e.isArray(t)?t:[t]}function i(t,n){var i=!0;return e.find(n,function(n,s){var o=s==="type"?t.types:t.properties[s];s==="_id"&&(o=t._id);var u=e.intersection(r(n),r(o));if(u.length===0)return i=!1,!0}),i}var s=this.get(n.type),o=e.select(this.objects,function(e){return i(e,n)});return t.Collection.create(s,o)}},t.Type=function(t){this._id=t._id,this.type="/type/type",this.name=t.name,this.meta=t.meta||{},this.indexes=t.indexes||{},this.properties=t.properties,e.each(this.properties,e.bind(function(t,n){t.type=e.isArray(t.type)?t.type:[t.type],t.unique=e.isBoolean(t.unique)?t.unique:!0},this))},e.extend(t.Type.prototype,e.Events,{toJSON:function(){return{_id:this._id,type:"/type/type",properties:this.properties,meta:this.meta,indexes:e.map(this.indexes,function(e){return e.properties})}}}),t.Object=function(e,t){this._id=e._id,this.host=t,this.properties={},this.set(e)},e.extend(t.Object.prototype,e.Events,{type:function(){return this.host.get(e.last(this.types))},property:function(t){var n=null;return e.find(e.clone(this.types).reverse(),e.bind(function(e){return n=this.host.get(e).properties[t]},this)),n},get:function(n,r){var i=this.property(n),s=this.properties[n];return!i||s===undefined?null:t.isValueType(i.type)?s:i.unique?this.host.get(s):e.map(s,e.bind(function(e){return this.host.get(e)},this))},set:function(t){var n=this;t.type&&(this.types=e.isArray(t.type)?t.type:[t.type]),t.meta&&(this.meta=this.object.meta),e.each(t,e.bind(function(e,t){if(!n.property(t)||t==="type")return;n.properties[t]=e},this))},toJSON:function(){return e.extend(this.properties,{_id:this._id,type:this.types})}}),t.Graph=function(e,t){this.nodes=[],this.objects=[],this.types=[],this.keys={};if(!e)return;this.merge(e)},e.extend(t.Graph.prototype,t.Query,e.Events,{merge:function(t){return e.each(t,e.bind(function(t,n){this.set(e.extend(t,{_id:n}))},this)),this},get:function(e){return this.nodes[this.keys[e]]},set:function(n){function i(){return e.last(r)==="/type/type"?new t.Type(n):new t.Object(n,this)}var r=e.isArray(n.type)?n.type:[n.type];n._id=n._id?n._id:t.uuid("/"+e.last(e.last(r).split("/"))+"/");var s=this.get(n._id);return s?s.set(n):(s=i.apply(this),this.keys[n._id]=this.nodes.length,this.nodes.push(s),e.last(r)==="/type/type"?this.types.push(s):this.objects.push(s)),s},find:function(e){return this.query(e)},del:function(e){var t=this.get(e);if(!t)return;t._deleted=!0},toJSON:function(t){var n={};return e.each(this.nodes,function(e){n[e._id]=e.toJSON()}),n}}),t.Collection=function(n){this.type=new t.Type(n.type,this),this.objects=[],this.length=0,this.keys={},e.each(n.objects,e.bind(function(e){this.add(e)},this))},t.Collection.create=function(n,r){var i=new t.Collection({type:n,objects:[]});return i.objects=e.clone(r),i.length=r.length,i.buildKeys(),i},e.extend(t.Collection.prototype,e.Events,t.Query,{buildKeys:function(){this.keys={},e.each(this.objects,function(e,t){this.keys[e._id]=t},this)},get:function(e){return e.match("^/type/")?this.type:this.objects[this.keys[e]]},at:function(e){return this.objects[e]},index:function(e){return this.keys[e]},key:function(e){return this.objects[e]._id},add:function(n){var r;return n instanceof t.Object?(r=n,this.keys[r._id]=this.objects.length,this.objects.push(r),this.length=this.objects.length):(n._id=n._id?n._id:t.uuid("/"+e.last(this.type._id.split("/"))+"/"),n.type=this.type._id,r=this.get(n._id),r?r.set(n):(r=new t.Object(n,this),this.keys[r._id]=this.objects.length,this.objects.push(r),this.length=this.objects.length)),r},del:function(e){if(this.keys.hasOwnProperty(e)){var t=this.length,n=this.keys[e];this.objects.splice(n,1),this.buildKeys(),this.length=t-1}return this},find:function(e){return e.type=this.type._id,this.query(e)},each:function(t){return e.each(this.objects,function(e,n){t.call(this,e,e._id,n)},this),this},first:function(){return this.length>0?this.objects[0]:null},last:function(){return this.length>0?this.objects[this.length-1]:null},range:function(e,n){var r=t.Collection.create(this.type,[]);for(var i=e;i<=n&&i<this.objects.length;i++)r.add(this.at(i));return r},intersect:function(n){var r=this,i=new t.Collection.create(this.type,[]),s,o;return n.length<r.length?(s=n,o=r):(s=r,o=n),e.each(s.objects,function(e,t){o.get(e._id)&&i.add(n.get(e._id))}),i},union:function(e){var n=this,r=new t.Collection.create(this.type,[]);return this.each(function(e,t){r.add(e)}),e.each(function(e,t){r.get(t)||r.add(e)}),r},difference:function(e){var n=this,r=new t.Collection.create(this.type,[]);return this.each(function(t,n){e.get(n)||r.add(t)}),r},toJSON:function(){return{type:this.type.toJSON(),objects:e.map(this.objects,function(e){return e.toJSON()})}}}),t});