define(["jquery","backbone","underscore","components/pollable_collection"],function(e,t,n,r){var i=t.sync,s,o,u,a,f,i;return f={node:["type","name","lastRunStatus"],link:["type","source","target"]},s=t.Model.extend({}),o=s.extend({idAttribute:"name",lastRunWasFailure:function(){return this.get("lastRunStatus")==="failure"},getLastRunDate:function(){return this.get(this.lastRunWasFailure()?"lastError":"lastSuccess")},getChildren:function(){return this.sources&&this.targets?this.sources.concat(this.targets):[]},getRelatedAsTree:function(e){var t=this.toJSON(),r=this.getChildren(),i;return e||(e=[this]),i=n.filter(r,function(t){return!n.any(e,function(e){return e.get("name")===t.get("name")})}),t.children=n.map(i,function(t){return t.getRelatedAsTree(r.concat(e))}),t},getRelated:function(e){e||(e=[]);var t=this.getChildren(),r,i;return r=n.filter(t,function(t){return!n.any(e,function(e){return e.get("name")===t.get("name")})}),i=n.map(r,function(n){return n.getRelated(t.concat(e))}),n.flatten(t.concat(i))}}),u=s.extend({}),a=t.Collection.extend(n.extend({},r,{url:"/scheduler/graph/csv",parse:function(e,t){var r=n.compact(e.split("\n"));return n.map(r,function(e){var t=e.split(",");return n.object(f[t[0]],t)})},sync:function(e,t,r){return i.call(this,e,t,n.extend({},r,{dataType:"text"}))},model:function(e,t){var n=e.type==="link"?u:o;return new n(e,t)},initialize:function(e,t){this.listenTo(this,{add:this.buildGraph,remove:this.buildGraph,reset:this.buildGraph})},buildGraph:function(){var e=this.where({type:"link"}),t=this.where({type:"node"}),r,i,s;n.each(t,function(t){r=t.get("name"),i=[],s=[],n.each(e,function(e){e.get("target")===r?i.push(this.get(e.get("source"))):e.get("source")===r&&s.push(this.get(e.get("target")))},this),n.extend(t,{sources:i,targets:s})},this)},getPaths:function(e){var t,r;return e||(e={}),n.chain(this.where({type:"link"})).filter(function(i){return e.parents?(t=i.get("target"),r=i.get("source"),e.parents[t]||e.parents[r]):n.isEmpty(e)}).value()},getNodes:function(e){var t;return e||(e={}),n.chain(this.where({type:"node"})).filter(function(t){return n.isEmpty(e)?!0:e[t.get("name")]}).value()},getWithRelatedNodes:function(e){var t=this.get(e),r=t.getRelated(),i;return i=n.reduce(r,function(e,t){return e[t.get("name")]=!0,e},{}),i[e]=!0,i},getPlainNodes:function(e){var t;return e||(e={}),t=e.scope,n.chain(this.getNodes()).filter(function(e){return t?t[e.get("name")]:!0}).map(function(e,t){return{name:e.get("name"),fail:e.lastRunWasFailure(),date:e.getLastRunDate(),id:t}}).value()},getPlainPaths:function(e){var t,r,i;return e||(e={}),t=e.scope,r=this.getPaths(),t?i=n.reduce(t,function(e,i,s){var o,u,a,f,l,c;return n.each(r,function(n){o=n.get("source"),u=n.get("target"),f=!i.locked,a=!f&&u===i.id,l=f&&o===i.id&&t[u],c=f&&u===i.id&&t[o],(a||l||c)&&e.push(n)}),e},[]):i=r,n.map(i,function(e){return{sourceName:e.get("source"),targetName:e.get("target"),inScope:!0,weight:1}})},getLastStatus:function(e){var t=n.has(e,"id")?e.id:e,r;return r=n.first(this.getNodes({id:t})||[]),r?r.get("lastRunStatus"):null},watchAccessoryLastSuccess:function(e,t,n){var r=this.get(e.id);!r||r.set("lastSuccess",t)},watchAccessoryLastError:function(e,t,n){var r=this.get(e.id);!r||r.set("lastError",t)},registerAccessoryCollection:function(e){var t=this,n;return n=function(t,n){var r=e.get(t.id);!r||(r.set("lastRunStatus",n),t.set({lastError:r.get("lastError"),lastSuccess:r.get("lastSuccess")}))},this.listenTo(e,{"change:lastSuccess":this.watchAccessoryLastSuccess,"change:lastError":this.watchAccessoryLastError,sync:function(e){t.each(function(e){if(!a.isNode(e))return;n(e,e.get("lastRunStatus"))})}}),e.listenTo(this,{"change:lastRunStatus":n,reset:function(e,t){e.each(function(e){n(e,e.get("lastRunStatus"))})}}),this}}),{isNode:function(e){return e.get("type")==="node"},isPath:function(e){return e.get("type")==="link"}}),a});